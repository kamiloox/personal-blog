---
title: Zapewne robisz to Åºle, czyli token na frontendzie ğŸ™…â€â™‚ï¸
date: 03-19-2022
category: javascript
published: true
excerpt: CoÅ› tutaj wymyÅ›lÄ™ ğŸ¤”
---

Wiele aplikacji, ktÃ³re sÄ… w sieci, korzystajÄ… z systemÃ³w uwierzytelniania i autoryzacji. Wszyscy na codzieÅ„ logujemy siÄ™ i rejestrujemy. JuÅ¼ czasami moÅ¼na siÄ™ pogubiÄ‡ w iloÅ›ci haseÅ‚ i loginÃ³w jakie musimy zapamiÄ™taÄ‡. Mimo, Å¼e taki scenariusz jest czÄ™sto uÅ¼ywany, to jego zakodowanie juÅ¼ nie jest takie proste. Trzeba to wszystko dobrze przemyÅ›lec na backendzie, jak i na frontendzie. Nie moÅ¼emy przecieÅ¼ uÅ‚atwiaÄ‡ pracy potencjalnym _hakerom_. Dlatego ten artykuÅ‚ omawia, jak powinniÅ›my obchodziÄ‡ siÄ™ z tokenem ğŸ¤­

## Scenariusz logowania i rejestracji

Logowanie i rejestracja na wielu stronach dziaÅ‚a podobnie. UÅ¼ytkownik wchodzÄ…c na serwisy takie jak Facebook, Youtube, czy Github, musi wykonaÄ‡ nastÄ™pujÄ…ce kroki:

1. przejÅ›Ä‡ na stronÄ™ rejestracji;
2. podaÄ‡ dane, ktÃ³re bÄ™dÄ… go identyfikowaÄ‡ i pozwolÄ… mu siÄ™ zalogowaÄ‡ pÃ³Åºniej;
3. potwierdziÄ‡ istnienie adresu email klikajÄ…c link w mailu;
4. logowanie i _voila_, moÅ¼na dziaÅ‚aÄ‡ i wstawiaÄ‡ nowe posty ğŸ¥³

Jak taki scenariusz wyglÄ…da w praktyce pod maskÄ…?

<Image alt="Komunikacja aplikacji z serwerem. UÅ¼ytkownik rejestruje siÄ™ i loguje, a serwer zwraca mu token" src='/images/auth-flow.pl.jpg' layout="responsive" width="993" height="518" />

Proces logowania i rejestracji na powyÅ¼szym zdjÄ™ciu jest bardzo mocno uproszczony. Jednak to nie o proces uwierzytelniania chodzi w tym artykule. Jak moÅ¼esz zauwaÅ¼yÄ‡ przy _5 punkcie_ jest napisane - _uÅ¼ytkownik jest zalogowany a jego token..._. No wÅ‚aÅ›nie, co siÄ™ dzieje w tym momencie z tokenem? Musimy mieÄ‡ do niego dostÄ™p, jeÅ¼eli chcemy wykonywaÄ‡ zapytania do serwera i poÅ›wiadczyÄ‡, __Å¼e my to my__. PowinniÅ›my go zapisaÄ‡ w pamiÄ™ci przeglÄ…darki, Å¼eby uÅ¼ytkownik za kaÅ¼dym razem gdy wchodzi na stronÄ™, nie musiaÅ‚ siÄ™ ponownie uwierzytelniaÄ‡.

## Przechowywanie tokena w localStorage

Jak juÅ¼ szczÄ™Å›liwie otrzymaliÅ›my token, to moÅ¼emy go zapisaÄ‡ w obiekcie __[localStorage](https://developer.mozilla.org/pl/docs/Web/API/Window/localStorage)__ przeglÄ…darki. W jaki sposÃ³b moÅ¼na to zrobiÄ‡?

```js
const signInUser = async (login, password) => {
  const signInURL = 'http://website.com/auth/signin'
  try {
    const response = await fetch(signInURL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ login, password }),
    });

    const { data } = await res.json();

    const { accessToken } = data;

    // Zapisz token w localStorage
    localStorage.setItem('accessToken', accessToken);
  } catch (err) {
    console.error('Ooops, coÅ› poszÅ‚o nie tak', err);
  }
};
```

Przechowywanie danych w localStorage jest jakimÅ› rozwiÄ…zaniem. Jednak trzeba pamiÄ™taÄ‡, Å¼e to zostaje zapisane w przeglÄ…darce uÅ¼ytkownika, a jak wiadomo __wszystko co znajduje siÄ™ na frontendzie moÅ¼e zostaÄ‡ przez kaÅ¼dego sprawdzone, nawet przez osobe trzeciÄ…__! Taki sposÃ³b jest podatny na ataki __[XSS](https://sekurak.pl/czym-jest-xss/)__. KtoÅ› moÅ¼e _wstrzyknÄ…Ä‡_ wywoÅ‚anie skryptu na naszej stronie, ktÃ³ry przechwyci token. PrzecieÅ¼ nie chcemy, Å¼eby trafiÅ‚ on w nieodpowiednie rÄ™ce.

<Image alt="Token zapisany w obiekcie localStorage" src='/images/token-xss.jpg' layout="responsive" width="1034" height="328" />

Jak widaÄ‡, jeÅ¼eli strona jest sÅ‚abo zabezpieczona, to moÅ¼na Å‚atwo pobraÄ‡ zawartoÅ›Ä‡ tokena. Dlatego _localStorage_ to bardzo niebezpieczne rozwiÄ…zanie i powinniÅ›my z niego zrezygnowaÄ‡. Na szczÄ™Å›cie mamy jeszcze inne moÅ¼liwoÅ›ci. Zobaczmy gdzie indziej moÅ¼na zapisaÄ‡ token.

## Pzechowywanie tokena w ciasteczku

[Ciasteczko](https://developer.mozilla.org/en-US/docs/Web/API/Document/cookie) (ang. _cookie_) rÃ³wnieÅ¼ pozwala przechowywaÄ‡ informacje na stronie. Jednak rÃ³Å¼ni siÄ™ od _localStorage_ tym, Å¼e moÅ¼e zostaÄ‡ ustawione zarÃ³wno przez serwer backendowy lub przez aplikacje frontendowÄ…. JeÅ¼eli zdecydujemy siÄ™ na ustawienie ciasteczka na frontendzie, to bÄ™dzie tak samo jak wczeÅ›niej, Å¼e ktoÅ› moÅ¼e je wykraÅ›Ä‡. Dlatego powinniÅ›my zapisywaÄ‡ ciasteczko z tokenem poprzez serwer. ByÄ‡ moÅ¼e zapytasz - _Co to zmieni jak ustawiÄ™ ciasteczko przez backend? PrzecieÅ¼ to dalej bÄ™dzie zapisane w przeglÄ…darce_. Tak, to prawda. Tylko moÅ¼emy wtedy ustawiÄ‡ pewne flagi, do ktÃ³rych na frontendzie nie mamy dostÄ™pu.

### Flaga _httpOnly_

WÅ‚Ä…czona flaga _httpOnly_ zabezpiecza ciasteczko przed jego odczytaniem w aplikacji. JeÅ¼eli sprawdzimy zawartoÅ›Ä‡ _document.cookie_ to go tam nie bÄ™dzie. Jedynie moÅ¼na go podglÄ…dnÄ…Ä‡ w narzÄ™dziach deweloperskich przeglÄ…darki, ale poprzez skrypt nie moÅ¼emy go odczytaÄ‡. Wprowadza to bardzo duÅ¼y stopieÅ„ bezpieczeÅ„stwa. OdciÄ…Å¼amy teÅ¼ w ten sposÃ³b aplikacjÄ™ frontendowÄ…. Nie musimy juÅ¼ martwiÄ‡ siÄ™ o umieszczaniu w nagÅ‚Ã³wku tokena, poniewaÅ¼ ciasteczko jest za kaÅ¼dym razem dodawane w zapytaniu.

W przykÅ‚adzie zaÅ‚Ã³Å¼my, Å¼e frontend i backend sÄ… pod tym samym adresem. Po pierwsze na frontendzie w funkcji _fetch_ trzeba ustawiÄ‡ jednÄ… opcjÄ™.

```js
fetch(signInURL, {
  method: 'POST',
  credentials: 'include', // Trzeba to ustawiÄ‡!
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({ login, password }),
});
```

Ustawienie opcji `credentials: 'same-origin'` pozwala nam na doÅ‚Ä…czanie ciasteczek do zapytania, w obrÄ™bie tego samego _origin_. __[Origin](https://developer.mozilla.org/en-US/docs/Glossary/Origin)__ jest tym co widzimy w naszym pasku adresu na stronie internetowej.

<Image alt="Token zapisany w obiekcie localStorage" src='/images/origin.pl.jpg' layout="responsive" width="973" height="253" />

Jako ciekawostkÄ™ moÅ¼na teÅ¼ ustawiÄ‡ opcjÄ™ _credentials_ na _include_. UmoÅ¼liwia to przesyÅ‚anie ciasteczek miÄ™dzy rÃ³Åºnymi _origin_, ale to juÅ¼ nie jest bezpieczne poniewaÅ¼ inne serwery backendowe mogÅ‚yby odczytaÄ‡ nasze ciasteczko.

Teraz na backendzie musimy ustawiÄ‡ naszemu ciasteczku flagÄ™ _httpOnly_ na _true_. W tym przykÅ‚adzie serwer jest postawiony na [NodeJS](https://nodejs.org/) przy wsparciu [ExpressJS](https://expressjs.com/).

```js
const MAX_AGE_1_MONTH = 1000 * 3600 * 24 * 30;
res.cookie('access_token', accessToken, {
  httpOnly: true,
  maxAge: MAX_AGE_1_MONTH,
});
```

I juÅ¼ mamy bezpieczniejszÄ… autoryzacjÄ™ w naszej aplikacji. Ciasteczko _access\_token_ nie bÄ™dzie zwracane gdy podejrzymy zawartoÅ›Ä‡ _document.cookie_. Jednak to nie jest jeszcze koniec, nasza aplikacja ma jeszcze jednÄ… wadÄ™.

### Flaga _secure_

Ciasteczko z flagÄ… _secure_, jak sama nazwa moÅ¼e sugerowaÄ‡, jest tylko wysyÅ‚ane do serwera zaszyfrowanym zapytaniem _HTTPS_. JeÅ¼eli nasza strona nie wykorzystuje tego protokoÅ‚u, to token nie zostanie przesÅ‚any. Chroni nas to przed przypadkowym wejÅ›ciem uÅ¼ytkownika na naszÄ… stronÄ™ przez protokÃ³Å‚ _HTTP_, ktÃ³ry by wysyÅ‚aÅ‚ _niebezpieczne_ zapytania.

```js
const MAX_AGE_1_MONTH = 1000 * 3600 * 24 * 30;
res.cookie('access_token', accessToken, {
  httpOnly: true,
  secure: true,
  maxAge: MAX_AGE_1_MONTH,
});
```

### Flaga _sameSite_

